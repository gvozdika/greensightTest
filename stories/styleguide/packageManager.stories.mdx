import { Meta } from '@storybook/addon-docs/blocks';

<Meta title="Styleguide / Package Manager" />

# Package Manager

В качестве пакетного менеджера используется [yarn](https://yarnpkg.com/) 2-ой версии.

yarn v2 установлен локально через зависимости проекта в `.yarn/releases`. При работе внутри воркспейса RWBP эта зависимость перекроет глобально установленный yarn v1. При этом глобально рекомендуется держать установленным v1 для работы над проектами без поддержки v2.

Можно проверить используемую версию yarn:

```bash
yarn -v
```

Конфигурация yarn прописана в `.yarnrc.yml`. Структура этого файла описана в документации [Yarnrc files](https://yarnpkg.com/configuration/yarnrc).

## PnP

yarn v2 использует концепт [Plug'n'Play](https://yarnpkg.com/features/pnp), позволяющий отказаться от директории `node_modules`. Вместо неё используется кэш `.yarn/cache` и скрипт `.pnp.js`, говорящий Node где найти соответствующие зависимости. Единственное для чего ещё используется `node_modules` – это хранение кэша ряда лоадеров / плагинов.

## Установка зависимостей

В yarn есть концепт [Zero-installs](https://yarnpkg.com/features/zero-installs), но RWBP его не поддерживает. Это означает, что `.yarn/cache` и `.pnp.js` не хранятся в репозитории. Что в свою очередь означает, что при старте работы / переключении ветки нужно выполнять установку зависимостей:

```bash
yarn
```

## Интеграция с VSCode

Чтобы у вас работали ESLint/Prettier/Typescript на уровне IDE, необходимо запустить команду:

```bash
yarn pnpify --sdk vscode
```

Эта команда использует локально установленный `@yarnpkg/pnpify` и создаст директорию `sdk` в директории `.yarn`. Подробности смотри в гайде [Editor SDKs](https://yarnpkg.com/advanced/editor-sdks).

## Запуск скриптов

Запуск скриптов должен происходить через yarn. Т.е. если вы ранее запускали node напрямую, то теперь нужно писать yarn node:

```bash
yarn node test
```

Для скриптов из `package.json` это не нужно, т.к. они запускаются через yarn:

```bash
yarn dev
```

Это нужно, чтобы yarn проставил все необходимые переменные окружения и корректно отрезолвил ваши зависимости. Например, без этого не будет определена переменная `process.versions.pnp`, по которой происходит проверка на PnP.

Также в yarn встроен инструмент для запуска внешних скриптов по аналогии с npx: `yarn dlx`. Например:

```bash
yarn dlx @yarnpkg/doctor
```

## Webpack

Чтобы webpack работал c PnP в резолверах используется `pnp-webpack-plugin`.

## dependencies

Установка всех зависимостей RWBP идёт в dependencies, т.к. devDependencies не несут смысла в контексте копируемого бланка. Разделение зависимостей только тратит время на подбор правильной группы. Также dependencies используются для исключения вендоров из серверного бандла через node-externals, так что следите за тем, что на проекте нет devDependencies (не используйте флаг -D).

## Shell

Yarn v2 обрабатывает кроссплатформенную передачу переменных в скрипты, так что этот скрипт сработает в Windows Powershell:

```bash
PORT=5000 yarn dev
```

Для 1-ой версии для этого был нужен модуль `cross-env`.

## Plugins

Yarn v2 поддерживает расширение через плагины. Плагины ставятся через команду:

```bash
yarn plugin import <name>
```

Эта команда установит плагин в `.yarn/plugins` и пропишет путь до него в `.yarnrc.yml`.

В RWBP по умолчанию установлен плагин upgrade-interactive. Попробуйте его для обновления версий зависимостей:

```bash
yarn upgrade-interactive
```
